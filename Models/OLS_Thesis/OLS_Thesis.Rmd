---
title: "Hedonic Pricing Models"
output:
  html_notebook: default
  pdf_document: default
  word_document: default
code_folding: hide
Author: Sawyer Benson
---

### Sawyer Benson's Master Thesis 
### Janurary 10, 2022


```{r message=TRUE, warning=TRUE, include=FALSE, results='hide'}

#Read in packages and data

library(readxl) # Import excel data frames
library(ggplot2) # Graphs
library(scales) # Scale range of ggplots 
library(ggfortify) # Additional ggplot2 functionality
library(olsrr) # Testing for heteroscedasticity
library(lmtest) # Testing for heteroscedasticity using breuch-pagan
library(sandwich) # Amending heteroskedasticity 
library(mcvis) # Visualizing multicollinearity
library(gridExtra) # Organize graphs
library(dplyr) # data_factor wrangling
library(tidyr) # data_factor wrangling
library(tinytex) #for RMarkdown
library(openxlsx) #Export data frame into Excel
library(ggeffects) # plotting marginal effects
library(sjPlot) # plotting marginal effects
library(stargazer) # Showing several outputs next to each other in a STATA style
library(modelsummary) # Showing several outputs next to each other in a STATA style
library(regclass) # for testing multicollinearity using VIF
library(jtools) # cleaner regression output (e.g. summ(lm) 
library(tidyverse) # data cleaning
library(hrbrthemes) # special boxplots
library(viridis) # special boxplots
library(plotly) # For 3D plotting in ggplot2

# Import and attach data sets
data_factor <- read_excel("/Users/sawyerbenson/Documents/Master Thesis/HPM_Thesis/Models/Data/New Data/3. data_factor_cleaned.xlsx")
attach(data_factor)

# Convert Char to Factors with N Levels
# Structure Change
data_factor$property_type <- as.factor(data_factor$property_type)
data_factor$ac_type <- as.factor(data_factor$ac_type)
data_factor$patio <- as.factor(data_factor$patio)
data_factor$school_general <- as.factor(data_factor$school_general)
data_factor$pool <- as.factor(data_factor$pool)
data_factor$roof_type <- as.factor(data_factor$roof_type)
data_factor$gas_type <- as.factor(data_factor$gas_type)
data_factor$out_building <- as.factor(data_factor$out_building)
data_factor$appliances <- as.factor(data_factor$appliances)
data_factor$garage <- as.factor(data_factor$garage)
data_factor$property_condition <- as.factor(data_factor$property_condition)
data_factor$energy_efficient <- as.factor(data_factor$energy_efficient)
data_factor$exterior_type <- as.factor(data_factor$exterior_type)
data_factor$exterior_features <- as.factor(data_factor$exterior_features)
data_factor$fireplace <- as.factor(data_factor$fireplace)
data_factor$foundation_type <- as.factor(data_factor$foundation_type)
data_factor$beds_total <- as.factor(data_factor$beds_total)
data_factor$bath_full <- as.factor(data_factor$bath_full)
data_factor$bath_half <- as.factor(data_factor$bath_half)
data_factor$sewer_type <- as.factor(data_factor$sewer_type)
data_factor$property_style <- as.factor(data_factor$property_style)
data_factor$subdivision <- as.factor(data_factor$subdivision)
data_factor$water_type <- as.factor(data_factor$water_type)
data_factor$waterfront <- as.factor(data_factor$waterfront)
data_factor$sold_date <- openxlsx::convertToDate(data_factor$sold_date)
data_factor$sold_date <- as.numeric(data_factor$sold_date)

str(data_factor)

# Splits
data_factor$city_limits <- as.factor(data_factor$city_limits)
data_factor$corona_date_split <- as.factor(data_factor$corona_date_split)
data_factor$top25_sold_price <- as.factor(data_factor$top25_sold_price)
data_factor$bottom25_sold_price <- as.factor(data_factor$bottom25_sold_price)
data_factor$top25_area_living <- as.factor(data_factor$top25_area_living)
data_factor$bottom25_area_living  <- as.factor(data_factor$bottom25_area_living)
data_factor$top25_age <- as.factor(data_factor$top25_age)
data_factor$bottom25_age <- as.factor(data_factor$bottom25_age)
data_factor$top25_dom <- as.factor(data_factor$top25_dom)
data_factor$bottom25_dom <- as.factor(data_factor$bottom25_dom)
data_factor$infections_period <- as.numeric(data_factor$infections_accum > 1000)
data_factor$infections_period <- as.factor(data_factor$infections_period)

str(data_factor)

# Remove this weird '20' level is bath_full
levels(data_factor$bath_full)
is.na(data_factor$bath_full) <- data_factor$bath_full == "20"
data_factor$bath_full <- factor(data_factor$bath_full)
levels(data_factor$bath_full)

# Remove beds_total > 5
levels(data_factor$beds_total)
is.na(data_factor$beds_total) <- data_factor$beds_total == "7" 
data_factor$beds_total <- factor(data_factor$beds_total)
is.na(data_factor$beds_total) <- data_factor$beds_total == "6" 
data_factor$beds_total <- factor(data_factor$beds_total)
levels(data_factor$beds_total)



levels(data_factor$beds_total)
levels(data_factor$bath_full)
levels(data_factor$bath_half)

# Data frame without Split Vars
names(data_factor)
data_factor_core <- data_factor[-c(36:47)]
data_factor_core <- subset(data_factor_core, select = -c(city_limits, mls_number, infections_period))
str(data_factor_core)
names(data_factor_core)

# Define Colors
very_low <- "#460f5c"
low <- "#2c728e"
med <- "#27ad81"
high <- "#f4e61e"

```


```{r include=FALSE}

# RMarkdown Code: Format chunk output into scroll lists
# Installed to limit the length of regression output
# save the built-in output hook
hook_output <- knitr::knit_hooks$get("output")

# set a new output hook to truncate text output
knitr::knit_hooks$set(output = function(x, options) {
  if (!is.null(n <- options$out.lines)) {
    x <- xfun::split_lines(x)
    if (length(x) > n) {
      # truncate the output
      x <- c(head(x, n), "....\n")
    }
    x <- paste(x, collapse = "\n")
  }
  hook_output(x, options)
})
``` 

### 1. Model Design: Checks & Corrections

#### 1.1 Accounting for Heteroskedasticity
```{r echo=TRUE, warning=FALSE, attr.output='style="max-height: 250px;"'}

# All-inclusive model
lm_pre_alpha <- lm(sold_price ~ . , data = data_factor_core)
summ(lm_pre_alpha)

# pre_alphaing for heteroskedasticity
#  a. Graphically
par(mfrow = c(2,2))
plot(lm_pre_alpha)

#autoplot(lm_pre_alpha)

#  b. Statistically
ols_test_breusch_pagan(lm_pre_alpha) # Breusch-Pagan test

# - Resolving Heteroskedasticity using heteroskedasticity-consistent (HC) variance covariance matrix

# Compare models
stargazer(lm_pre_alpha,
          coeftest(lm_pre_alpha, vcov = vcovHC(lm_pre_alpha, method = "White2", type = "HC0")),
          coeftest(lm_pre_alpha, vcov = vcovHC(lm_pre_alpha, method = "White2", type = "HC1")),
          type = "text")


```

<br>

#### 1.2 Accounting for Interactions

**Note:** Advisor suggested not to inlude interaction terms except for specific testing.
```{r eval=FALSE, include=FALSE}
#data_binary_test <- data_binary[1:20]
#data_binary_test$sold_price <- data_binary$sold_price

#data_binary_test <- data_binary[1:15]

#lm_check_binary <- lm(data_binary$sold_price ~ ., data = data_binary_test)

#(start.time <- Sys.time())
#lm_check_binary_interactions <- lm(data_binary$sold_price ~ .^2, data = data_binary_test)
#(end.time <- Sys.time())
#(time.taken <- end.time - start.time)

#options(max.print=1000000)
#summary(lm_check)

#94^2 # Number of interactions checked

# Isolating only the interaction which are statistically significant

# 1. Create Boolean vector
#toselect_x <- summary(lm_check_binary_interactions)$coeff[-1,4] < 0.1

# 2. select sig. variables
#relevant_x <- names(toselect_x)[toselect_x == TRUE]
# PROBLEM: interaction are being name with a '1' at the end and that is fucking up the indexing for the last equation.
#(relevant_x <- sub("1", "", relevant_x))

# 3. formula with only sig. variables
#(sig_formula <- as.formula(paste("data_binary$sold_price ~",paste(relevant_x, collapse = "+"))))

# sig_model <- lm(formula = sig_formula, data_binary_test)
# summary(sig_model)

# Compare models
#summ(lm_check_binary, robust = "HC1")
#summ(lm_check_binary_interactions, robust = "HC1")
#summ(sig_model, robust = "HC1")
#stargazer(coeftest(lm_check, vcov = vcovHC(lm_check, method = "White2", type = "HC1")),
#          coeftest(lm_check_binary_interactions, vcov = vcovHC(lm_check_binary_interactions, method = "White2", type = "HC1")),
#          coeftest(sig_model, vcov = vcovHC(sig_model, method = "White2", type = "HC1")),
#         type = "text")
```

<br>

#### 1.3 Accounting for Non-linearity

##### 1.3.1 Age
```{r, warning=FALSE, attr.output='style="max-height: 250px;"'}
# Age
a <- ggplot(data_factor, aes(x = age , y = sold_price)) +
     geom_smooth(aes(fill = infections_period)) +
     geom_smooth(linetype = "dashed", color = "grey32") +
     theme_minimal() +
     #scale_fill_manual(values=c(very_low, med)) +
     labs(title = "Age and Price",
          x = "Age",
          y = "Price") +
     scale_fill_manual(values = c(very_low, med), 
                      name = "Infection Period",
                      labels = c("Pre", "Post"))
     

a

# Actual vs. fit

# Model with non-linear addition
lm_pre_alpha_age <- lm(sold_price ~ . + I(age^2), data = data_factor_core)
summ(lm_pre_alpha_age)

# Marginal effects data frames
ggpredict_1 <- ggpredict(lm_pre_alpha, terms = "age")
ggpredict_2 <- ggpredict(lm_pre_alpha_age, terms = "age")

# Plots
b <- ggplot(data_factor_core, aes( x = age)) +
   geom_smooth(data_factor_core, mapping = aes(y = sold_price), color = "grey50") +
   geom_smooth(ggpredict_1, mapping = aes(x, predicted), linetype = "dashed", color = very_low) +
   geom_smooth(ggpredict_2, mapping = aes(x, predicted), linetype = "dashed", color = med) +
     labs(title = "Age and Price",
          x = "Age",
          y = "Prediction")

# Look at age & age^2 alone to see impact on more relevant y-axis scale
c <- ggplot() +
   geom_smooth(ggpredict_1, mapping = aes(x, predicted), linetype = "dashed", color = very_low) +
   geom_smooth(ggpredict_2, mapping = aes(x, predicted), linetype = "dashed", color = med) +
     labs(title = "Age and Price",
          x = "Age",
          y = "Prediction") 

a
gridExtra::grid.arrange(b,c, nrow =2, ncol = 1)

```

<br>

##### 1.3.2 Living Area
```{r, warning=FALSE, attr.output='style="max-height: 250px;"'}
# Living Area

# General graphing
a <- ggplot(data_factor, aes(x = area_living , y = sold_price)) +
     geom_smooth(aes(fill = infections_period)) +
     geom_smooth(linetype = "dashed", color = "grey32") +
     theme_minimal() +
     #scale_fill_manual(values=c(very_low, med)) +
     labs(title = "Living Area and Price",
          x = "Living Area",
          y = "Price") +
     scale_fill_manual(values = c(very_low, med), 
                      name = "Infection Period",
                      labels = c("Pre", "Post"))

a

ggplot(data_factor, aes(x = area_living , y = sold_price/area_living)) + 
    geom_point(aes(color = infections_period), alpha = 0.15) + 
    geom_smooth(aes(color = infections_period)) +
    geom_smooth(color = "grey50", linetype = "dashed") +
    theme_minimal()

# Actual vs. fit
# Model with non-linear addition
lm_pre_alpha_area <- lm(sold_price ~ . + I(area_living^2), data = data_factor_core)
summ(lm_pre_alpha_area)

# Model with single-variable fit
lm_pre_alpha_area_single <- lm(sold_price ~ area_living, data = data_factor_core)
summ(lm_pre_alpha_area_single)

# Marginal effects data frames
ggpredict_1 <- ggpredict(lm_pre_alpha, terms = "area_living") # total model
ggpredict_2 <- ggpredict(lm_pre_alpha_area, terms = "area_living") # non-linear addition
ggpredict_3 <- ggpredict(lm_pre_alpha_area_single, terms = "area_living") # single-variable fit

# Plots
b <- ggplot(data_factor_core, aes(x = area_living)) +
   geom_smooth(data_factor, mapping = aes(y = sold_price), color = "grey50") +
   geom_smooth(ggpredict_1, mapping = aes(x, predicted), linetype = "dashed", color = very_low) +
   geom_smooth(ggpredict_2, mapping = aes(x, predicted), linetype = "dashed", color = med) +
     labs(title = "Living Area and Price",
          x = "Living Area",
          y = "Prediction")

# Look at age & age^2 alone to see impact on more relevant y-axis scale
c <- ggplot() +
   geom_smooth(ggpredict_1, mapping = aes(x, predicted), linetype = "dashed", color = very_low) +
   geom_smooth(ggpredict_2, mapping = aes(x, predicted), linetype = "dashed", color = med) +
     labs(title = "Living Area and Price",
          x = "Living Area",
          y = "Prediction")

# Conclusion
a
gridExtra::grid.arrange(b,c, nrow =2, ncol = 1)

```

<br>

##### 1.3.3 Land
```{r, warning=FALSE, attr.output='style="max-height: 250px;"'}
# General graphing
ggplot(data_factor, aes(x = land_acres , y = sold_price)) + 
    geom_point(aes(color = infections_period), alpha = 0.15) + 
    geom_smooth(aes(color = infections_period)) +
    geom_smooth(color = "grey50", linetype = "dashed") +
    theme_minimal()

ggplot(data_factor, aes(x = land_acres, y = sold_price/land_acres)) + 
    geom_point(aes(color = infections_period), alpha = 0.15) + 
    geom_smooth(aes(color = infections_period)) +
    geom_smooth(color = "grey50", linetype = "dashed") +
    theme_minimal()
```

<br>

##### 1.3.4 Non-linear Additions

```{r, echo=TRUE}
#Additions
data_factor_core_clean <- data_factor_core
data_factor_core_clean$age_2 <- I(data_factor_core$age^2)
data_factor_core_clean$area_living_2 <- I(data_factor_core$area_living^2)
```

<br>

#### 1.4 Accounting for Multicollinearity
```{r, warning=FALSE, attr.output='style="max-height: 250px;"'}
# Full model summary
summ(lm_pre_alpha)

# Check Variance Inflation Factors (VIF)
VIF(lm_pre_alpha)
alias(lm_pre_alpha)

# Total area and living area are found to be significantly (i.e. VIF > 5) multicolinear (expected)
# Solution: Remove area_total

# Note the significant drop in R^2 from 0.99 to 0.86
lm_pre_alpha_cleaned <- lm(log(sold_price) ~ . - area_total ,data = data_factor_core)
summ(lm_pre_alpha_cleaned)
VIF(lm_pre_alpha_cleaned)

# Final pre_alpha
VIF(lm_pre_alpha_cleaned)
alias(lm_pre_alpha_cleaned)

# Another way to check for multicollinearity is visually through the mcvis package
data_numeric <- select_if(data_factor_core, is.numeric) # Subset numeric columns with dplyr
mcvis_result <- mcvis(X = data_numeric)
a <- plot(mcvis_result)

par(mfrow = c(2,2))
#Removals
data_numeric <- subset(data_numeric, select = -c(list_price))
mcvis_result <- mcvis(X = data_numeric)
b <- plot(mcvis_result)

#Removals
data_numeric <- subset(data_numeric, select = -c(area_total))
mcvis_result <- mcvis(X = data_numeric)
c <- plot(mcvis_result)

a
b
c



```

```{r, echo=FALSE,out.width="49%", out.height="20%",fig.cap="caption",fig.show='hold',fig.align='center'}

install.packages("cowplot")
install.packages("magick")
library(magick)
library(cowplot)
library(ggplot2)

p1 <- ggdraw() + draw_image("/Users/sawyerbenson/Documents/Master Thesis/Thesis_Github/Writing & Literature/Graphics from pptx/Multi_colin/multi_co1.png", scale = 1)
p2 <- ggdraw() + draw_image("/Users/sawyerbenson/Documents/Master Thesis/Thesis_Github/Writing & Literature/Graphics from pptx/Multi_colin/Multi_co2.png", scale = 1)

p3 <- ggdraw() + draw_image("/Users/sawyerbenson/Documents/Master Thesis/Thesis_Github/Writing & Literature/Graphics from pptx/Multi_colin/Multi_co3.png", scale = 1)

plot_grid(p1, p2, p3)
``` 

<br>

##### 1.4.1 Multicollinearity Removals
```{r, warning=FALSE, attr.output='style="max-height: 250px;"'}
# Removals
# - Area_total
# - Listing price

par(mfrow = c(2,2))

data_factor_core_clean <- subset(data_factor_core_clean, select = -c(area_total, list_price))
```

<br>

#### 1.5 High-leverage Removals
```{r}

data_factor_core_clean <- data_factor_core_clean[-c(23515), ]

```


<br>

### 1.5 Alpha Model
```{r, warning=FALSE, attr.output='style="max-height: 250px;"'}

# Finalized base model
lm_alpha <- glm(sold_price ~ . ,data = data_factor_core_clean)


summ(lm_alpha)
coeftest(lm_alpha, vcov = vcovHC(lm_alpha, method = "White2", type = "HC0"))

par(mfrow = c(2,2))
plot(lm_alpha)

cl <- makePSOCKcluster(5)
registerDoParallel(cl)
tab_model(lm_alpha, ci_method = "wald")
stopCluster(cl)

```

<br>

#### 2. Factor Analysis

##### 2.1 Corona
###### 2.1.1 Visualization
```{r, attr.output='style="max-height: 250px;"'}

# Waves of infection
ggplot(data_factor, aes(x = as.Date(sold_date), y = infections_3mma)) + 
    geom_point(color = low, alpha = 0.7) + 
    geom_smooth(linetype = "dashed", color = med) +
    theme_minimal() +
    scale_x_date(limits = as.Date(c("2020-01-01", "2021-12-31"))) +
    scale_y_continuous(limits = c(0,max(infections_3mma))) +
    xlab(" ") +
    ylab("Confirmed Infections per Day") +
    labs(title = "Waves of Infection",
         caption = "") +
    geom_vline(xintercept = as.numeric(as.Date("2020-03-23")), linetype=4)

# Accumulation of infections
ggplot(data_factor, aes(x = as.Date(sold_date), y = I(infections_accum/1000))) + 
    geom_point(color = low, alpha = 0.7) + 
    geom_smooth(linetype = "dashed", color = med) +
    theme_minimal() +
    scale_x_date(limits = as.Date(c("2020-01-01", "2021-12-31"))) +
    scale_y_continuous(limits = c(0,max(I(infections_accum/1000)))) +
    xlab(" ") +
    ylab("Accumulation of Infections (in 000's)") +
    labs(title = "Accumulation of Infections",
         caption = "")

# Infections and home prices
ggplot(data_factor, aes(x = I(infections_3mma/1000), y = sold_price)) + 
    #geom_point() + 
    geom_smooth(linetype = "dashed", color = med) +
    theme_minimal() +
    scale_x_continuous( limits = c(0,max(I(infections_3mma/1000)))) +
    xlab("3-Month Moving Average of Daily Infections (in 000's)") +
    ylab("Sold Price (Actual)") +
    labs(title = "Infections and Price",
         caption = "")



# "#ff6c67", "#00c2c6"

ggplot(data_factor, aes(x = infections_period, y = sold_price/1000, fill = infections_period)) +
    geom_violin(alpha = 0.5) +
    geom_boxplot(width=0.1) +
    scale_fill_viridis(discrete = TRUE, alpha=0.6, option="D") +
    coord_flip() +
    theme_ipsum() +
    theme(
      legend.position="none") +
    xlab("Infections Present (1 = yes)") +
    ylab("Sold Price (in 000's)") +
    scale_fill_manual(values=c(very_low, med)) +
    labs(title = "Comparison of Sold Price",
         caption = "")



```

<br><br>

###### 2.1.2 Modeling
```{r, warning=FALSE, attr.output='style="max-height: 250px;"'}
# Testing Corona
lm_corona <- lm(sold_price ~ infections_3mma + . 
                
                ,data = data_factor_core_clean)

summ(lm_corona)
coeftest(lm_corona, vcov = vcovHC(lm_corona, method = "White2", type = "HC0"))

# Table output
tab_model(lm_corona, 
          auto.label = TRUE, 
          collapse.ci = TRUE,
          terms = c("(Intercept)", "infections_3mma"))


# Visualizing marginal effect per positive tests on price
lm_corona_single <- lm(sold_price ~ infections_3mma 
                
                ,data = data_factor_core_clean)
summ(lm_corona_single)


ggpredict_1 <- ggpredict(lm_corona, terms = "infections_3mma")
ggpredict_2 <- ggpredict(lm_corona_single, terms = "infections_3mma")

# Plots
ggplot(data_factor_core, aes(x = infections_3mma)) +
   geom_smooth(data_factor_core, mapping = aes(y = sold_price), color = "grey50") + # Actual Data
   geom_smooth(ggpredict_1, mapping = aes(x, predicted), linetype = "dashed", color = low) + # Controlled model
   geom_smooth(ggpredict_2, mapping = aes(x, predicted), linetype = "dashed", color = med) + # Best single fit
   ggtitle("Model Fit Overview")
 
# Predicting infections with house prices
lm_flip <- lm_flip <- lm(infections_3mma ~ sold_price , data = data_factor)
summ(lm_flip)

ggpredict_flip <- ggpredict(lm_flip, terms = "sold_price")

ggplot(data_factor, aes(x = sold_price)) +
   geom_smooth(data_factor, mapping = aes(y = infections_3mma), color = "grey50") +
   geom_smooth(ggpredict_flip, mapping = aes(x, predicted), linetype = "dashed", color = "darkred") +
   labs(title = "Flipped Regression", subtitle = "Explining Infections using Variations in Price",
         caption = "") 

```

<br>

##### 2.2 Corona on Number of Bedrooms

###### 2.2.1 Visualiztion
```{r, warning=FALSE}

# Distribution
# Find the mean of each group
library(plyr)
data_factor$beds_total <- as.numeric(data_factor$beds_total)
room_mean <- ddply(data_factor, "infections_period", summarise, beds_mean=mean(beds_total, na.rm = TRUE))

data_factor$beds_total <- as.numeric(data_factor$beds_total)
a <- ggplot(data_factor, aes(x=beds_total, fill = infections_period)) +
    geom_density(alpha = 0.5, position = "identity") +
    scale_fill_manual(values=c(very_low, med)) +
    labs(title = "Distibution of Number of Bedrooms") +
    geom_vline(data=room_mean, aes(xintercept = room_mean[2,2]), linetype="dashed", size= 0.4, color = very_low, alpha = 0.5) +
    geom_vline(data=room_mean, aes(xintercept = room_mean[1,2]), linetype="dashed", size= 0.4, alpha = 0.5) +
    xlab("Number of Bedrooms") +
    ylab("Density") +
    labs(fill = "Infection Period")


# Distribution of total price and number of beds
data_factor$beds_total <- as.factor(data_factor$beds_total)
b <- ggplot(data = subset(data_factor, !is.na(beds_total)), aes(x = beds_total, y = sold_price, fill = beds_total)) +
    geom_violin(alpha = 0.5) +
    geom_boxplot(width=0.1) +
    scale_fill_viridis(discrete = TRUE, alpha=0.6, option="D") +
    #coord_flip() +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=14)) +
      labs(title = "Distributions of Sold Price by Number of Bedrooms",
         caption = "") +
      xlab("Number of Bedrooms") +
      ylab("Sold Price")

      #+
      #scale_fill_manual(values = c(very_low, med), 
      #                name = "Infection Period",
      #                labels = c("Pre", "Post"))

# Distribution of price and number of beds before and after corona period
c <- ggplot(data = subset(data_factor, !is.na(beds_total)), aes(x = beds_total, y = sold_price, fill = beds_total)) +
    geom_violin(data = subset(data_factor, !is.na(beds_total)), mapping = aes(alpha = 0.5, fill = infections_period)) +
    geom_boxplot(width=0.1) +
    scale_fill_viridis(discrete = TRUE, alpha=0.6, option="D") +
    #coord_flip() +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=14)) +
      labs(title = "Distributions of Sold Price by Number of Bedrooms", 
           subtitle = "Price Pre vs. Post Infection Period",
           caption = "") +
      xlab("Number of Bedrooms")  +
      ylab("Sold Price")

# Distribution of price per sqft. and number of beds
data_factor$beds_total <- as.factor(data_factor$beds_total)
d <- ggplot(data = subset(data_factor, !is.na(beds_total)), aes(x = beds_total, y = sold_price/area_living, fill = beds_total)) +
    geom_violin(alpha = 0.5) +
    geom_boxplot(width=0.1) +
    scale_fill_viridis(discrete = TRUE, alpha=0.6, option="D") +
    #coord_flip() +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=14)) +
      labs( title = "Distributions of Sold Price by Number of Bedrooms", subtitle = "Sold Price Per Sqft.",
         caption = "") +
      xlab("Number of Bedrooms") +
      ylab("Sold Price per Sqft.")
  

# Distribution of price per sqft. and number of beds before and after corona period
e <- ggplot(data = subset(data_factor, !is.na(beds_total)), aes(x = beds_total, y = sold_price/area_living , fill = beds_total)) +
    geom_violin(data = subset(data_factor, !is.na(beds_total)), mapping = aes(alpha = 0.5, fill = infections_period)) +
    geom_boxplot(width=0.1) +
    scale_fill_viridis(discrete = TRUE, alpha=0.6, option="D") +
    #coord_flip() +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=14)) +
      labs( title = "Distributions of Sold Price by Number of Bedrooms", subtitle = "Sold Price Per Sqft. Pre vs. Post Infection Period",
         caption = "") +
      xlab("Number of Bedrooms")  +
      ylab("Sold Price per Sqft.")

gridExtra::grid.arrange(a)
gridExtra::grid.arrange(b)
gridExtra::grid.arrange(c)
gridExtra::grid.arrange(d)
gridExtra::grid.arrange(e)
#gridExtra::grid.arrange(b,c, ncol = 2)


```

###### 2.2.2 Modeling

Ideas

* Break into each room number

```{r, warning=FALSE, attr.output='style="max-height: 250px;"'}
# Note on bedroom's relationship with all other size-related features:
#  - The interpretation of the coefficient is dependent on the other fixed size features, especially area_living. In the case that total area is fixed, the interpretation of this coefficient become the effect of more bedrooms for a fixed size. No one wants a 500 sqft. house with 8 bedrooms.  
#  - For this reason, when analyzing changes in bedrooms, total size is excluded

# Change data structure to factor
data_factor_core_clean$beds_total <- as.factor(data_factor_core_clean$beds_total)

# Single Model: Factor
lm_corona_bedrooms_single <- lm(sold_price ~ + beds_total ,data = data_factor_core_clean)
summ(lm_corona_bedrooms_single)
coeftest(lm_corona_bedrooms_single, vcov = vcovHC(lm_corona_bedrooms_single, method = "White2", type = "HC0"))

# Basic Test: Few Controls
lm_corona_bedrooms_basic <- lm(sold_price ~ 
                      + data_factor$infections_3mma + beds_total + data_factor$infections_3mma*beds_total 

                       # Removals
                       - area_living
                       - area_living_2 
                       - bath_full
                       - bath_half
                       - land_acres
                       - sold_date
                       - garage
                       - property_type
                      
                            ,data = data_factor_core_clean)
summ(lm_corona_bedrooms_basic)
coeftest(lm_corona_bedrooms_basic, vcov = vcovHC(lm_corona_bedrooms_basic, method = "White2", type = "HC0"))

# General Model: Controlled
lm_corona_bedrooms <- lm(sold_price ~ . +
               
                       # test variable(s)                    
                       + data_factor$infections_3mma + beds_total + data_factor$infections_3mma*beds_total
                       
                       # Removals
                       - area_living
                       - area_living_2 
                       - bath_full
                       - bath_half
                       - land_acres
                       - sold_date
                       - garage
                       - property_type
                       
                       ,data = data_factor_core_clean)
summ(lm_corona_bedrooms)
coeftest(lm_corona_bedrooms, vcov = vcovHC(lm_corona_bedrooms, method = "White2", type = "HC0"))

# Table output
tab_model(lm_corona_bedrooms, 
          auto.label = TRUE, 
          collapse.ci = TRUE,
          terms = c("(Intercept)", 
                    "beds_total1:data_factor$infections_3mma",
                    "beds_total2:data_factor$infections_3mma",
                    "beds_total3:data_factor$infections_3mma",
                    "beds_total4:data_factor$infections_3mma",
                    "beds_total5:data_factor$infections_3mma"))

```

<br>

##### 2.3 Corona on Price Quantiles

###### 2.3.1 Visualization
```{r}

# Find the mean of each group
library(plyr)
price_means <- ddply(data_factor, "infections_period", summarise, price_mean = mean(sold_price, na.rm = TRUE))

# Distribution: Total
ggplot(data_factor, aes(x = sold_price)) +
    geom_density(alpha = 0.5, position = "identity", fill = very_low) +
    ggtitle("Price Distribution") +
    geom_vline(data=price_means, aes(xintercept = mean(sold_price)), linetype="dashed", size= 0.4, color = very_low, alpha = 0.8) +
    xlab("Sold Price") +
    ylab("Density") 

# Distribution: Infection
ggplot(data_factor, aes(x = sold_price, fill = infections_period)) +
    geom_density(alpha = 0.5, position = "identity") +
    ggtitle("Price Distributions") +
    geom_vline(data=price_means, aes(xintercept = price_means[2,2]), linetype="dashed", size= 0.4, color = med, alpha = 0.8) +
    geom_vline(data = price_means, aes(xintercept = price_means[1,2]), linetype="dashed", size= 0.4, color = very_low, alpha = 0.8) +
    scale_fill_manual(values = c(very_low, med), 
                      name = "Infection Period",
                      labels = c("Pre", "Post")) +
    xlab("Sold Price") +
    ylab("Density") +
    labs(fill = "Infection Period")

# Distribution: Top vs. Bottom
ggplot(data_factor) +
    geom_density(aes(x = sold_price, fill = infections_period), alpha = 0.5, position = "identity") + 
    facet_grid(vars(top25_sold_price, bottom25_sold_price), scales = "free") +
    ggtitle("Price Distributions") +
    scale_fill_manual(values=c(very_low, med)) +
    xlab("Sold Price") +
    labs(fill = "Infection Period") +
    ylab("Density") +
    scale_fill_manual(values = c(very_low, med), 
                      name = "Infection Period",
                      labels = c("Pre", "Post"))

#Price and Infections
ggplot(data_factor, aes(x = infections_period, y = sold_price, fill = infections_period)) +
    geom_violin(alpha = 0.5) +
    geom_boxplot(width=0.1) +
    scale_fill_viridis(discrete = TRUE, alpha=0.6, option="D") +
    coord_flip() +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)) +
    ggtitle("Comparison of Sold Price") +
    xlab("Infection Period") +
    scale_fill_manual(values=c(very_low, med)) +
    ylab("Sold Price") 

```

<br>

###### 2.3.2 Modeling
```{r, warning=FALSE, attr.output='style="max-height: 250px;"'}

# Testing Corona, top 25% in price ---------------------------------------------------------------------

# Single Var Test
lm_corona_price_top_single <- lm(sold_price ~ . 
               
                       # test variable(s)                    
                       + data_factor$top50_sold_price
                       
                       # Removals
                       
                       ,data = data_factor_core_clean)
summ(lm_corona_price_top_single)
coeftest(lm_corona_price_top_single, vcov = vcovHC(lm_corona_price_top_single, method = "White2", type = "HC0"))


# General Model: No Controls 
lm_corona_price_top_basic <- lm(sold_price ~ +
               
                       # test variable(s)                    
                       + data_factor$infections_3mma + data_factor$top50_sold_price 
                       + data_factor$infections_3mma*data_factor$top50_sold_price
                       
                       # Removals
                       
                        ,data = data_factor_core_clean)
summ(lm_corona_price_top_basic)
coeftest(lm_corona_price_top_basic, vcov = vcovHC(lm_corona_price_top_basic, method = "White2", type = "HC0"))

# General Model: With Controls 
lm_corona_price_top <- lm(sold_price ~ . +
               
                       # test variable(s)                    
                       + data_factor$infections_3mma + data_factor$top50_sold_price 
                       + data_factor$infections_3mma*data_factor$top50_sold_price
                       
                       # Removals
                       
                       ,data = data_factor_core_clean)
summ(lm_corona_price_top)
coeftest(lm_corona_price_top, vcov = vcovHC(lm_corona_price_top, method = "White2", type = "HC0"))

# Testing Corona, Bottom 25% in price ------------------------------------------------------------------

# Single Var Test
lm_corona_price_bottom_single <- lm(sold_price ~ +
               
                       # test variable(s)                    
                       + bottom25_sold_price
                       
                       # Removals
                       
                       ,data = data_factor_core_clean)
summ(lm_corona_price_bottom_single)
coeftest(lm_corona_price_bottom_single, vcov = vcovHC(lm_corona_price_bottom_single, method = "White2", type = "HC0"))

# General Model: No controls
lm_corona_price_bottom_basic <- lm(sold_price ~ +
               
                       # test variable(s)                    
                       + data_factor$infections_3mma + bottom25_sold_price +
                         data_factor$infections_3mma*bottom25_sold_price
                       
                       # Removals
                       
                       ,data = data_factor_core_clean)
summ(lm_corona_price_bottom_basic)
coeftest(lm_corona_price_bottom_basic, vcov = vcovHC(lm_corona_price_bottom_basic, method = "White2", type = "HC0"))

# General Model: With controls
lm_corona_price_bottom <- lm(sold_price ~ . +
                         
                       # test variable(s)                    
                       + data_factor$infections_3mma + bottom25_sold_price
                       + data_factor$infections_3mma*bottom25_sold_price
                         
                       # Removals
                       - sold_date
                         
                         ,data = data_factor_core_clean)
summ(lm_corona_price_bottom)
coeftest(lm_corona_price_bottom, vcov = vcovHC(lm_corona_price_bottom, method = "White2", type = "HC0"))

```

<br>

##### 2.4 Corona on Age Quantiles

###### 2.4.1 Visualization
```{r}
# Conditional Mean
library(plyr)
age_mean_data <- ddply(data_factor, "infections_period", summarise, age_mean = mean(age, na.rm = TRUE))

# Distribution: Total
ggplot(data_factor, aes(x = age)) +
    geom_density(alpha = 0.5, position = "identity", fill = very_low) +
    ggtitle("Age Distribution") +
    geom_vline(aes(xintercept = mean(age)), linetype="dashed", size= 0.4, alpha = 0.5, color = very_low) +
    xlab("Age of Property") +
    ylab("Density")


# Distribution: Infection
ggplot(data_factor, aes(x = age, fill = infections_period)) +
    geom_density(alpha = 0.5, position = "identity") +
    ggtitle("Age Distributions") +
    scale_fill_manual(values = c(very_low, med), 
                      name = "Infection Period",
                      labels = c("Pre", "Post")) +
    geom_vline(data = age_mean_data, aes(xintercept = age_mean_data[2,2]), linetype="dashed", size= 0.5, color = med, alpha = 0.8) +
    geom_vline(data = age_mean_data, aes(xintercept = age_mean_data[1,2]), linetype="dashed", size= 0.5, alpha = 0.8, color = very_low) +
    xlab("Age of Property") +
    ylab("Density")

?scale_fill_discrete()

# Distribution: Top vs. Bottom
ggplot(data_factor) +
    geom_density(aes(x = age, fill = infections_period), alpha = 0.5, position = "identity") + 
                     facet_grid(vars(top25_age, bottom25_age), scales = "free") +
                     ggtitle("Age Distributions") +
    scale_fill_manual(values = c(very_low, med), 
                      name = "Infection Period",
                      labels = c("Pre", "Post")) +
    labs(fill = "Infection Period") +
    xlab("Age of Property") +
    ylab("Density")

#Age on Infections
ggplot(data_factor, aes(x = infections_period, y = age, fill = infections_period)) +
    geom_violin(alpha = 0.5) +
    geom_boxplot(width=0.1) +
    scale_fill_viridis(discrete = TRUE, alpha=0.6, option="D") +
    coord_flip() +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=14)) +
    ggtitle("Comparison of Age") +
    xlab("Infection Period") +
    ylab("Age of Property") +
    scale_fill_manual(values = c(very_low, med), 
                      name = "Infection Period",
                      labels = c("Pre", "Post"))




```

###### 2.4.2 Modeling
```{r, warning=FALSE, attr.output='style="max-height: 250px;"'}

# Testing Corona, age, general
lm_corona_age <- lm(sold_price ~ .
               
                        # test variable(s)                    
                        + data_factor$infections_3mma + age + data_factor$infections_3mma*age 
                       
                        # Removals
                        - age
                        #- age_2
                        - property_type
                       
                       ,data = data_factor_core_clean)
coeftest(lm_corona_age, vcov = vcovHC(lm_corona_age, method = "White2", type = "HC0"))
# Table output
tab_model(lm_corona_age, 
          auto.label = TRUE, 
          collapse.ci = TRUE,
          terms = c("(Intercept)",
                    "age:data_factor$infections_3mma"))


# Testing Corona, top 25% in age
lm_corona_age_top_single <- lm(sold_price ~
               
                        # test variable(s)                    
                        + top25_age
                       
                        # Removals
                        - age
                        - age_2
                        - property_type
                       
                       ,data = data_factor_core_clean)
coeftest(lm_corona_age_top_single, vcov = vcovHC(lm_corona_age_top_single, method = "White2", type = "HC0"))

lm_corona_age_top <- lm(sold_price ~ .
               
                        # test variable(s)                    
                        + data_factor$infections_3mma + top25_age + data_factor$infections_3mma*top25_age 
                       
                        # Removals
                        - age
                        - age_2
                        - property_type
                       
                       ,data = data_factor_core_clean)
coeftest(lm_corona_age_top, vcov = vcovHC(lm_corona_age_top, method = "White2", type = "HC0"))

# Table output
tab_model(lm_corona_age_top, 
          auto.label = TRUE, 
          collapse.ci = TRUE,
          terms = c("(Intercept)",
                    "data_factor$infections_3mma:top25_age"))

# Testing Corona, bottom 25% in age
lm_corona_age_bottom_single <- lm(sold_price ~ 
               
                        # test variable(s)                    
                        + bottom25_age
                       
                        # Removals
                        - age
                        - age_2
                        - property_type
                       
                       ,data = data_factor_core_clean)
coeftest(lm_corona_age_bottom, vcov = vcovHC(lm_corona_age_bottom, method = "White2", type = "HC0"))

lm_corona_age_bottom <- lm(sold_price ~ .
               
                        # test variable(s)                    
                        + data_factor$infections_3mma + bottom25_age + data_factor$infections_3mma*bottom25_age 
                       
                        # Removals
                        - age
                        - age_2
                        - property_type
                        - area_living
                       
                       ,data = data_factor_core_clean)
coeftest(lm_corona_age_bottom, vcov = vcovHC(lm_corona_age_bottom, method = "White2", type = "HC0"))

tab_model(lm_corona_age_bottom, 
          auto.label = TRUE, 
          collapse.ci = TRUE,
          terms = c("(Intercept)",
                    "data_factor$infections_3mma:bottom25_age"))

```

<br>

##### 2.5 Corona on Size Quantiles

###### 2.5.1 Visualization
```{r}
# Conditional Mean
library(plyr)
area_living_mean_data <- ddply(data_factor, "infections_period", summarise, area_living_mean = mean(area_living, na.rm = TRUE))

# Distribution: Total
ggplot(data_factor, aes(x = area_living)) +
    geom_density(alpha = 0.5, position = "identity", fill = very_low) +
    ggtitle("Living Area Distribution") +
    geom_vline(aes(xintercept = mean(area_living)), linetype="dashed", size= 0.4, alpha = 0.5, color = very_low) +
    xlab("Living Area") +
    ylab("Density")


# Distribution: Infection
ggplot(data_factor, aes(x = area_living, fill = infections_period)) +
    geom_density(alpha = 0.5, position = "identity") +
    ggtitle("Living Area Distributions") +
    geom_vline(data = area_living_mean_data, aes(xintercept = area_living_mean_data[2,2]), linetype="dashed", size= 0.5, color = med, alpha = 0.8) +
    geom_vline(data = area_living_mean_data, aes(xintercept = area_living_mean_data[1,2]), linetype="dashed", size= 0.5, alpha = 0.8, color = very_low) +
    xlab("Living Area") +
    ylab("Density") +
    scale_fill_manual(values = c(very_low, med), 
                      name = "Infection Period",
                      labels = c("Pre", "Post"))

# Distribution: Top vs. Bottom
ggplot(data_factor) +
    geom_density(aes(x = area_living, fill = infections_period), alpha = 0.5, position = "identity") + 
    facet_grid(vars(top25_area_living, bottom25_area_living), scales = "free") +
    ggtitle("Living Area Distributions") +
    xlab("Living Area") +
    ylab("Density") +
    scale_fill_manual(values = c(very_low, med), 
                      name = "Infection Period",
                      labels = c("Pre", "Post"))

#area_living on Infections
ggplot(data_factor, aes(x = infections_period, y = sold_price/area_living, fill = infections_period)) +
    geom_violin(alpha = 0.5) +
    geom_boxplot(width=0.1) +
    scale_fill_viridis(discrete = TRUE, alpha=0.6, option="D") +
    coord_flip() +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)) +
    ggtitle("Comparison of Living Area per Sqft.") +
    xlab("Infection Period") +
    ylab("Price per Living Area") +
    scale_fill_manual(values=c(very_low, med)) +
    scale_y_continuous(limits = c(0,250))




```

###### 2.5.2 Modeling
```{r, warning=FALSE, attr.output='style="max-height: 250px;"'}
# Testing Corona, area_living, general
lm_corona_area_living <- lm(sold_price ~ .
               
                        # test variable(s)                    
                        + data_factor$infections_3mma + area_living + data_factor$infections_3mma*area_living 
                       
                        # Removals
                        - area_living
                        - area_living_2
                        - property_type
                       
                       ,data = data_factor_core_clean)
coeftest(lm_corona_area_living, vcov = vcovHC(lm_corona_area_living, method = "White2", type = "HC0"))

# Table output
tab_model(lm_corona_area_living, 
          auto.label = TRUE, 
          collapse.ci = TRUE,
          terms = c("(Intercept)", 
                    "area_living:data_factor$infections_3mma"))



# Testing Corona, top 25% in area_living
lm_corona_area_living_top_single <- lm(sold_price ~ .
               
                        # test variable(s)                    
                        + top25_area_living
                       
                        # Removals
                        - area_living
                        - area_living_2
                        - beds_total
                        - property_type
                       
                       ,data = data_factor_core_clean)
coeftest(lm_corona_area_living_top_single, vcov = vcovHC(lm_corona_area_living_top_single, method = "White2", type = "HC0"))

lm_corona_area_living_top <- lm(sold_price ~ .
               
                        # test variable(s)                    
                        + data_factor$infections_3mma + top25_area_living + data_factor$infections_3mma*top25_area_living 
                       
                        # Removals
                        - area_living
                        - area_living_2
                        - property_type
                       
                       ,data = data_factor_core_clean)
coeftest(lm_corona_area_living_top, vcov = vcovHC(lm_corona_area_living_top, method = "White2", type = "HC0"))

# Table output
tab_model(lm_corona_area_living_top, 
          auto.label = TRUE, 
          collapse.ci = TRUE,
          terms = c("(Intercept)", 
                    "data_factor$infections_3mma:top25_area_living"))

# Testing Corona, bottom 25% in area_living
lm_corona_area_living_bottom_single <- lm(sold_price ~ .
               
                        # test variable(s)                    
                        + bottom25_area_living
                       
                        # Removals
                        - area_living
                        - area_living_2
                        - beds_total
                        - property_type
                       
                       ,data = data_factor_core_clean)
coeftest(lm_corona_area_living_bottom_single, vcov = vcovHC(lm_corona_area_living_bottom_single, method = "White2", type = "HC0"))

lm_corona_area_living_bottom <- lm(sold_price ~ .
               
                        # test variable(s)                    
                        + data_factor$infections_3mma + bottom25_area_living + data_factor$infections_3mma*bottom25_area_living 
                       
                        # Removals
                        - area_living
                        - area_living_2
                       
                       ,data = data_factor_core_clean)
coeftest(lm_corona_area_living_bottom, vcov = vcovHC(lm_corona_area_living_bottom, method = "White2", type = "HC0"))

# Table output
tab_model(lm_corona_area_living_bottom, 
          auto.label = TRUE, 
          collapse.ci = TRUE,
          terms = c("(Intercept)", 
                    "data_factor$infections_3mma:bottom25_area_living"))

```

<br>

##### 2.6 Corona on Days on Market

###### 2.6.1 Visualization
```{r}
# Conditional Mean
library(plyr)
dom_mean_data <- ddply(data_factor, "infections_period", summarise, dom_mean = mean(dom, na.rm = TRUE))

# Distribution: Just for City
ggplot(data_factor, aes(x = dom)) +
    geom_density(alpha = 0.5, position = "identity", fill = very_low) +
    ggtitle("Days on Market Distribution") +
    geom_vline(aes(xintercept = mean(dom)), linetype="dashed", size= 0.4, alpha = 0.5, color = very_low) +
    xlab("Days on Market") +
    ylab("Density")


# Distribution: Infection
ggplot(data_factor, aes(x = dom, fill = infections_period)) +
    geom_density(alpha = 0.5, position = "identity") +
    ggtitle("Days on Market Distributions") +
    geom_vline(data = dom_mean_data, aes(xintercept = dom_mean_data[2,2]), linetype="dashed", size= 0.5, color = med, alpha = 0.8) +
    geom_vline(data = dom_mean_data, aes(xintercept = dom_mean_data[1,2]), linetype="dashed", size= 0.5, alpha = 0.8, color = very_low) +
    xlab("Days on Market") +
    ylab("Density") +
    scale_fill_manual(values = c(very_low, med), 
                      name = "Infection Period",
                      labels = c("Pre", "Post"))

# Distribution: Top vs. Bottom
ggplot(data_factor) +
    geom_density(aes(x = dom, fill = infections_period), alpha = 0.5, position = "identity") + 
    facet_grid(vars(top25_dom, bottom25_dom), scales = "free") +
    ggtitle("Days on Market Distributions") +
    xlab("Days on Market") +
    ylab("Density") +
    scale_fill_manual(values = c(very_low, med), 
                      name = "Infection Period",
                      labels = c("Pre", "Post"))

#dom on Infections
ggplot(data_factor, aes(x = infections_period, y = dom, fill = infections_period)) +
    geom_violin(alpha = 0.5) +
    geom_boxplot(width=0.1) +
    scale_fill_viridis(discrete = TRUE, alpha=0.6, option="D") +
    #coord_flip() +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)) +
    ggtitle("Comparison of Days on Market") +
    xlab("Infection Period") +
    ylab("Days on Market") +
    scale_fill_manual(values = c(very_low, med), 
                      name = "Infection Period",
                      labels = c("Pre", "Post"))

```
###### 2.6.2 Modeling
```{r, warning=FALSE, attr.output='style="max-height: 250px;"'}

# Testing Corona, dom, general
lm_corona_dom <- lm(sold_price ~ .
               
                        # test variable(s)                    
                        + data_factor$infections_3mma + dom + data_factor$infections_3mma*dom 
                       
                        # Removals
                        - dom
                        - property_type
                       
                       ,data = data_factor_core_clean)
coeftest(lm_corona_dom, vcov = vcovHC(lm_corona_dom, method = "White2", type = "HC0"))

# Table output
tab_model(lm_corona_dom, 
          auto.label = TRUE, 
          collapse.ci = TRUE,
          terms = c("(Intercept)",
                    "dom:data_factor$infections_3mma"))


# Testing Corona, top 25% in dom
lm_corona_dom_top_single <- lm(sold_price ~ .
               
                        # test variable(s)                    
                        + top25_dom
                       
                        # Removals
                        - dom
                        - property_type
                       
                       ,data = data_factor_core_clean)
coeftest(lm_corona_dom_top_single, vcov = vcovHC(lm_corona_dom_top_single, method = "White2", type = "HC0"))

lm_corona_dom_top <- lm(sold_price ~ .
               
                        # test variable(s)                    
                        + data_factor$infections_3mma + top25_dom + data_factor$infections_3mma*top25_dom 
                       
                        # Removals
                        - dom
                        - property_type
                       
                       ,data = data_factor_core_clean)
coeftest(lm_corona_dom_top, vcov = vcovHC(lm_corona_dom_top, method = "White2", type = "HC0"))

# Table output
tab_model(lm_corona_dom_top, 
          auto.label = TRUE, 
          collapse.ci = TRUE,
          terms = c("(Intercept)",
                    "data_factor$infections_3mma:top25_dom"))

# Testing Corona, bottom 25% in dom
lm_corona_dom_bottom_single <- lm(sold_price ~ .
               
                        # test variable(s)                    
                        + bottom25_dom
                       
                        # Removals
                        - dom
                        - property_type
                       
                       ,data = data_factor_core_clean)
coeftest(lm_corona_dom_bottom_single, vcov = vcovHC(lm_corona_dom_bottom_single, method = "White2", type = "HC0"))

lm_corona_dom_bottom <- lm(sold_price ~ .
               
                        # test variable(s)                    
                        + data_factor$infections_3mma + bottom25_dom + data_factor$infections_3mma*bottom25_dom 
                       
                        # Removals
                        - dom
                        - property_type
                       
                       ,data = data_factor_core_clean)
coeftest(lm_corona_dom_bottom, vcov = vcovHC(lm_corona_dom_bottom, method = "White2", type = "HC0"))

# Table output
tab_model(lm_corona_dom_bottom, 
          auto.label = TRUE, 
          collapse.ci = TRUE,
          terms = c("(Intercept)",
                    "bottom25_dom1:data_factor$infections_3mma"))


# top 25% is too tight!! means aren't different

# this means that the premium for being in the bottom percentile of dom decreased. This make's sense because this was no longer a result of increased quality but increased demand.
```

<br>

##### 2.7 Corona on City

###### 2.7.1 Visualization
```{r, alpha = false}

# Distribution: Total 
ggplot(data = data_factor, aes(x = sold_price)) +
    geom_density(mapping = aes(fill = low, alpha = 0.5, position = "identity")) +
    ggtitle("Price Distributions of All Properties") +
    theme(legend.position = "none") +
    xlab("Sold Price") +
    ylab("Density") +
    scale_fill_manual(values = c(very_low))

# Distribution: City vs non-city

# Conditional Mean: City vs Rural
library(plyr)
city_limits_mean_data <- ddply(data_factor, "city_limits", summarise, city_limits_mean = mean(sold_price, na.rm = TRUE))

ggplot(data = data_factor, aes(x = sold_price, fill = city_limits)) +
    geom_density(alpha = 0.5, position = "identity") +
    ggtitle("Price Distributions of City vs Rural") +
    geom_vline(data = city_limits_mean_data, aes(xintercept = city_limits_mean_data[2,2]), linetype="dashed", size= 0.5, color = med, alpha = 0.8) +
    geom_vline(data = city_limits_mean_data, aes(xintercept = city_limits_mean_data[1,2]), linetype="dashed", size= 0.5, alpha = 0.8, color = very_low) +
    scale_fill_manual(values = c(very_low, med), 
                      name = "Infection Period",
                      labels = c("Rural", "City")) +
    xlab("Sold Price") +
    ylab("Density") 


# Conditional Mean: City pre vs post corona
library(plyr)
city_limits_mean_data <- ddply(subset(data_factor, data_factor$city_limits ==1 ), "infections_period", summarise, city_limits_mean = mean(sold_price, na.rm = TRUE))

# Distribution: Just City

# Conditional Mean: City pre vs post corona
library(plyr)
city_limits_mean_data <- ddply(subset(data_factor, data_factor$city_limits ==1 ), "infections_period", summarise, city_limits_mean = mean(sold_price, na.rm = TRUE))

ggplot(data = subset(data_factor, data_factor$city_limits ==1), aes(x = sold_price)) +
    geom_density(alpha = 0.5, position = "identity", fill = very_low) +
    ggtitle("Price Distribution of Properties in City Limits") +
    geom_vline(aes(xintercept = mean(city_limits)), linetype="dashed", size= 0.4, alpha = 0.5) +
    xlab("Sold Price") +
    ylab("Density")

# Distribution: Infection
ggplot(data = subset(data_factor, data_factor$city_limits ==1), aes(x = sold_price, fill = infections_period)) +
    geom_density(alpha = 0.5, position = "identity") +
    ggtitle("Price Distributions of Properties in City Limits") +
    geom_vline(data = city_limits_mean_data, aes(xintercept = city_limits_mean_data[2,2]), linetype="dashed", size= 0.5, color = med, alpha = 0.8) +
    geom_vline(data = city_limits_mean_data, aes(xintercept = city_limits_mean_data[1,2]), linetype="dashed", size= 0.5, alpha = 0.8, color = very_low) +
    scale_fill_manual(values = c(very_low, med), 
                      name = "Infection Period",
                      labels = c("Pre", "Post")) +
    xlab("Sold Price") +
    ylab("Density") 

#city_limits on Infections
ggplot(data_factor, aes(x = city_limits, y = sold_price, fill = infections_period)) +
    geom_violin(alpha = 0.5) +
    geom_boxplot(width=0.1, alpha = 0.9) +
    scale_fill_viridis(discrete = TRUE, alpha=0.6, option="D") +
    #coord_flip() +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=14)) +
    ggtitle("Comparison of Price: City Limts and Pre vs. Post Corona") +
    xlab("City Limits and Infection Period") +
    ylab("Sold Price") +
    scale_fill_manual(values = c(very_low, med), 
                      name = "City Limits",
                      labels = c("Pre", "Post"))

```

###### 2.7.2 Modeling
```{r, warning=FALSE, attr.output='style="max-height: 250px;"'}

# Testing Corona, City Limits
lm_corona_city <- lm(sold_price ~ . 
               
                       # test variable(s)                    
                       + data_factor$infections_3mma + data_factor$city_limits 
                       + data_factor$infections_3mma*data_factor$city_limits
                       
                       
                       ,data = data_factor_core_clean)
coeftest(lm_corona_city, vcov = vcovHC(lm_corona_city, method = "White2", type = "HC0"))

# Table output
tab_model(lm_corona_city, 
          auto.label = TRUE, 
          collapse.ci = TRUE,
          terms = c("(Intercept)",
                    "data_factor$infections_3mma",
                    "data_factor$city_limits1",
                    "data_factor$infections_3mma:data_factor$city_limits1"))


```

<br><br>

#### 3. Playground

<br>

##### 3.1 Index creation

```{r}

data_index <- read_excel("/Users/sawyerbenson/Documents/Master Thesis/Thesis_Github/Models/Data/New Data/Index_hardkey.xlsx")
attach(data_index)

data_index_fred <- read_excel("/Users/sawyerbenson/Documents/Master Thesis/Thesis_Github/Models/Data/New Data/Index_FRED.xls")
attach(data_index_fred)

data_index_gdp <- read_excel("/Users/sawyerbenson/Documents/Master Thesis/Thesis_Github/Models/Data/New Data/la_GDP.xls")
attach(data_index_gdp)

data_index_fred_1975_total <- read_excel("/Users/sawyerbenson/Documents/Master Thesis/Thesis_Github/Models/Data/New Data/Total_US_1975.xls")
attach(data_index_fred_1975_total)

# Index graphing
ggplot(data_index, aes(x = Date)) +
    geom_line(mapping = aes(y = lma_2m_index), color = "darkred") +
    geom_line(mapping = aes(y = lma_3m_index), color = "darkgreen") +
    geom_line(mapping = aes(y = lma_4m_index), color = "darkblue") +
    geom_line(mapping = aes(y = lma_5m_index), color = "grey45") +
    geom_vline(xintercept = as.numeric(as.Date("2020-03-23")), linetype=4, color = "green") +
    #scale_x_date(limits = as.Date(c("2020-01-01", "2021-12-31"))) +
    scale_y_continuous(limits = c(min(lma_2m_index),max(lma_2m_index))) +
    xlab(" ") +
    ylab("Weighted Average Price per Sqft.") +
    labs(title = "Louisiana Housing Index",
         caption = "") 

# FRED quarterly data
ggplot(data_index_fred, aes(x = date)) + 
    geom_line(aes(y = index_Q1_1980), color = "darkred") +
    theme_minimal() +
    geom_vline(xintercept = as.Date("2020-01-01"), linetype=4, color = "green") +
    #scale_x_date(limits = as.Date(c("2020-01-01", "2021-12-31"))) +
    scale_y_continuous(limits = c(min(index_Q1_1980),max(index_Q1_1980))) +
    xlab(" ") +
    ylab("Index Value") +
    labs(title = "Louisiana Housing Index: FRED St. Louis",
         caption = "") 

# La Real GDP data quarterly data
data_index_gdp <- subset(data_index_gdp, data_index_gdp$date >= as.Date("2011-07-01"))
ggplot(data_index_gdp, aes(x = date)) + 
    geom_line(aes(y = real_gdp_Index, color = "darkred"), linetype = "dashed", size = .5) +
    geom_line(aes(y = real_gdp_re_specific_index, color = "darkblue"), size = .5) +
    theme(legend.position = "bottom") +
    geom_vline(xintercept = as.Date("2020-01-01"), linetype = 4, color = "green") +
    #scale_x_date(limits = as.Date(c("2020-01-01", "2021-12-31"))) +
    #scale_y_continuous(limits = c(min(real_gdp_Index),max(real_gdp_Index))) +
    xlab(" ") +
    ylab("Index Value") +
    labs(title = "Louisiana GDP and Housing Index: FRED St. Louis",
         caption = "") +
         scale_color_discrete(name = "Infection Period",
                              labels = c("RE Index", "Aggrigate GDP Index"))

cor.test(real_gdp_Index, real_gdp_re_specific_index)

# TOTAL US Real GDP data quarterly data base 2011
ggplot(data_index_fred_total, aes(x = observation_date)) + 
    geom_line(aes(y = GDP, color = very_low), linetype = "dashed", size = .5) +
    geom_line(aes(y = all_re_index, color = med), size = .5) +
    theme(legend.position = "bottom" ) +
    geom_vline(xintercept = as.Date("2020-01-01"), linetype=4, color = "green") +
    #scale_x_date(limits = as.Date(c("2020-01-01", "2021-12-31"))) +
    #scale_y_continuous(limits = c(min(real_gdp_Index),max(real_gdp_Index))) +
    xlab(" ") +
    ylab("Index Value") +
    labs(title = "Total US GDP and Housing Index: FRED St. Louis",
         caption = "") +
         scale_color_discrete(name = "Infection Period",
                              labels = c("RE Index", "Aggrigate GDP Index"))
  
                    
# TOTAL US Real GDP data quarterly data base 1975

# Nominal
ggplot(data_index_fred_1975_total, aes(x = date)) + 
    geom_line(aes(y = gdp_pc_nom_index_1975 , color = very_low), linetype = "dashed", size = .5) +
    geom_line(aes(y = re_nom_index_1975, color = med), size = .5) +
    theme(legend.position = "bottom" ) +
    #geom_vline(xintercept = as.Date("2020-01-01"), linetype=4, color = "green") +
    #scale_x_date(limits = as.Date(c("2020-01-01", "2021-12-31"))) +
    #scale_y_continuous(limits = c(min(real_gdp_Index),max(real_gdp_Index))) +
    xlab(" ") +
    ylab("Index Value (1975 Q1 = 100)") +
    labs(title = "U.S. GDP and Housing Index",
         caption = "FRED, St. Louis") +
         scale_color_discrete(name = "",
                              labels = c("Nominal Housing Prices", "Nominal GDP Per-Capita"))

corr_nom_1975 <- cor(gdp_pc_nom_index_1975, re_nom_index_1975)


# Real
ggplot(data_index_fred_1975_total, aes(x = date)) + 
    geom_line(aes(y = gdp_pc_real_index_1975 , color = very_low), linetype = "dashed", size = .5) +
    geom_line(aes(y = re_real_index_1975, color = med), size = .5) +
    theme(legend.position = "bottom" ) +
    #geom_vline(xintercept = as.Date("2020-01-01"), linetype=4, color = "green") +
    #scale_x_date(limits = as.Date(c("2020-01-01", "2021-12-31"))) +
    #scale_y_continuous(limits = c(min(real_gdp_Index),max(real_gdp_Index))) +
    xlab(" ") +
    ylab("Index Value (1975 Q1 = 100)") +
    labs(title = "U.S. GDP and Housing Index",
         caption = "FRED, St. Louis") +
         scale_color_discrete(name = "",
                              labels = c("Real Housing Prices", "Real GDP Per-Capita"))

corr_real_1975 <- cor(gdp_pc_real_index_1975, re_real_index_1975)

corr_nom_1975
corr_real_1975


```

##### 3.2 Playing with Maps
```{r}
# packages
require(ggplot2)
install.packages("ggmap")
require(maps)
install.packages(Geoc)



#Basic Map
LA <- map_data("state", region="louisiana")
ggplot(LA, aes(x=long, y=lat))+geom_polygon()


# data
salesCalls <- data.frame(State=rep("louisiana",5), 
                             City=c("Baton Rouge","New Orleans", "Shreveport",       "Lafayette", "Mandeville"),
                             Calls=c(10,5,8,13,2))

salesCalls <- cbind(geocode(as.character(salesCalls$City)), salesCalls)



?cbind

ggplot(LA, aes(x=long, y=lat)) +
  geom_polygon() +
  coord_map() +
  geom_point(data=salesCalls, aes(x=lon, y=lat, size=Calls), color="orange")


```

##### 3.3 Reduction in Dimensionality

```{r}
library(boot) # K-fold
library(leaps) # Subset 
library(glmnet) #glmnet() is the main function in the glmnet package (must pass in an x matrix as well as a y vector)

# Set x-y definitions for glmnet package 
x <- model.matrix(sold_price ~ . ,data = data_factor_core_clean)[, -1]

y <- data_factor_core_clean$sold_price[1:24653] # Manually restricted due rows not matching with x 'x' for an unknown reason

# General grid
grid <- exp(seq(10, -65, length = 101)) #grid of values from exp(10) [null model] to exp(-15) [least squares]

#Lasso
set.seed(1)
cv.out <- cv.glmnet(x, y, alpha = 1, lambda = grid, nfolds = 10) #lasso
plot(cv.out)

# Base decision
bestlam <- cv.out$lambda.min; bestlam; log(bestlam)
out <- cv.out$glmnet.fit
lasso.coef <- predict(out, type = "coefficients", s = bestlam); lasso.coef; lasso.coef[lasso.coef != 0]
sum(abs(lasso.coef[1:31])) #l1 norm

# +1se decision
bestlam2 <- cv.out$lambda.1se; bestlam2; log(bestlam2)
lasso.coef2 <- predict(out, type = "coefficients", s = bestlam2); lasso.coef2; lasso.coef2[lasso.coef2 != 0]
sum(abs(lasso.coef2[2:31])) #l1 norm

```


##### 3.4 Basic 3D Graphing
```{r}
kd <- with(MASS::geyser, MASS::kde2d(sold_price, infections_3mma, n = 50))

fig <- plot_ly(x = kd$x, y = kd$y, z = kd$z) %>% add_surface()

fig
```

##### 3.4 Descriptive Stats

```{r}
# Correlation Matrix heatmap
# Get numeric variable

data_factor$bath_full < as.numeric(data_factor$bath_full)
num_vars <- data_factor %>% dplyr::select(where(is.numeric))
num_vars <- subset(num_vars, select = -c(top50_sold_price))

# Corr matrix
cormat <- round(cor(num_vars),2)
head(cormat)

melted_cormat <- melt(cormat)
head(melted_cormat)

ggplot(data = melted_cormat, aes(x=Var1, y=Var2, fill = value)) + 
   geom_tile() +
   scale_fill_gradient2(low = very_low, 
                        high = high, 
                        mid = med, 
                        midpoint = 0, 
                        limit = c(-1,1), 
                        space = "Lab", 
                        name="Correlation") +
   theme_minimal() + 
   theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 10, hjust = 1, color = "#2E2E2E"),
         axis.text.y = element_text(angle = 0, vjust = 1, size = 10, hjust = 1, color = "#2E2E2E")) +
   coord_fixed() +
   labs(title = "Correlation Matrix",
        x = "",
        y = "")


```

```{r}
# Distribution: Total
a <- ggplot(data_factor, aes(x = sold_price/1000)) +
    geom_density(alpha = 0.5, position = "identity", fill = very_low) +
    xlab("Sold Price") +
    ylab("") + 
    theme(axis.text.y=element_blank(), 
          axis.ticks.y=element_blank(),
          text = element_text(size=10)) 

b <- ggplot(data_factor, aes(x = list_price/1000)) +
    geom_density(alpha = 0.5, position = "identity", fill = very_low) +
    xlab("List Price") +
    ylab("") + 
    theme(axis.text.y=element_blank(), 
          axis.ticks.y=element_blank(),
          text = element_text(size=10)) 


c <- ggplot(data_factor, aes(x = area_living)) +
    geom_density(alpha = 0.5, position = "identity", fill = very_low) +
    xlab("Living Area") +
    ylab("") + 
    theme(axis.text.y=element_blank(), 
          axis.ticks.y=element_blank(),
          text = element_text(size=10)) 

d <- ggplot(data_factor, aes(x = land_acres)) +
    geom_density(alpha = 0.5, position = "identity", fill = very_low) +
    xlab("Land in Acres") +
    ylab("") + 
    theme(axis.text.y=element_blank(), 
          axis.ticks.y=element_blank(),
          text = element_text(size=10)) 

e <- ggplot(data_factor, aes(x = area_total)) +
    geom_density(alpha = 0.5, position = "identity", fill = very_low) +
    xlab("Total Area") +
    ylab("") + 
    theme(axis.text.y=element_blank(), 
          axis.ticks.y=element_blank(),
          text = element_text(size=10)) 

f <- ggplot(data_factor, aes(x = age)) +
    geom_density(alpha = 0.5, position = "identity", fill = very_low) +
    xlab("Age") +
    ylab("") + 
    theme(axis.text.y=element_blank(), 
          axis.ticks.y=element_blank(),
          text = element_text(size=10)) 

g <- ggplot(data_factor, aes(x = dom)) +
    geom_density(alpha = 0.5, position = "identity", fill = very_low) +
    xlab("DOM") +
    ylab("") + 
    theme(axis.text.y=element_blank(), 
          axis.ticks.y=element_blank(),
          text = element_text(size=10)) 

data_factor$sold_date <- as.Date(data_factor$sold_date)
str(data_factor)
h <- ggplot(data_factor, aes(x = sold_date)) +
    geom_density(alpha = 0.5, position = "identity", fill = very_low) +
    xlab("Sold Date") +
    ylab("") + 
    theme(axis.text.y=element_blank(), 
          axis.ticks.y=element_blank(),
          text = element_text(size=10)) +
    scale_x_date(date_labels = "%Y")

i <- ggplot(data = subset(data_factor, data_factor$infections_daily > 1), aes(x = infections_daily)) +
    geom_density(alpha = 0.5, position = "identity", fill = very_low) +
    xlab("Infections Daily") +
    ylab("") + 
    theme(axis.text.y=element_blank(), 
          axis.ticks.y=element_blank(),
          text = element_text(size=10)) 

data_factor$beds_total <- as.numeric(data_factor$beds_total)
j <- ggplot(data_factor, aes(x=beds_total)) +
    geom_density(alpha = 0.5, position = "identity", fill = very_low) +
    scale_fill_manual(values=c(very_low)) +
    xlab("Number of Bedrooms") +
    ylab("") + 
    theme(axis.text.y=element_blank(), 
          axis.ticks.y=element_blank(),
          text = element_text(size=10)) 

data_factor$bath_full <- as.numeric(data_factor$bath_full)
k <- ggplot(data_factor, aes(x=bath_full)) +
    geom_density(alpha = 0.5, position = "identity", fill = very_low) +
    scale_fill_manual(values=c(very_low)) +
    xlab("Number of Full Bathrooms") +
    ylab("") + 
    theme(axis.text.y=element_blank(), 
          axis.ticks.y=element_blank(),
          text = element_text(size=10)) 

data_factor$bath_half <- as.numeric(data_factor$bath_half)
l <- ggplot(data_factor, aes(x=bath_half)) +
    geom_density(alpha = 0.5, position = "identity", fill = very_low) +
    scale_fill_manual(values=c(very_low)) +
    xlab("Number of Half Bathrooms") +
    ylab("") + 
    theme(axis.text.y=element_blank(), 
          axis.ticks.y=element_blank(),
          text = element_text(size=10)) 

gridExtra::grid.arrange(a,b,c,d,e,f,g,h,i,j,k,l, nrow =4, ncol = 3)


```

##### 3.4 Simple UCLA Case 
```{r}
lm_ucla <- lm(sold_price ~ pool + infections_period + pool*infections_period, data = data_factor)
summ(lm_ucla)

# load package
library(sjPlot)
library(sjmisc)
library(sjlabelled)

tab_model(lm_ucla)

```

##### 3.5 Imagine Combinations
```{r, echo=FALSE,out.width="49%", out.height="20%",fig.cap="caption",fig.show='hold',fig.align='center'}

library(cowplot)
library(ggplot2)

p1 <- ggdraw() + draw_image("/Users/sawyerbenson/Documents/Master Thesis/HPM_Thesis/Writing & Literature/Graphics from pptx/Nonlinearities/age_non_lin.png", scale = 0.90)

p2 <- ggdraw() + draw_image("/Users/sawyerbenson/Documents/Master Thesis/HPM_Thesis/Writing & Literature/Graphics from pptx/Nonlinearities/age_non_lin_ols.png", scale = 0.90)

p3 <- ggdraw() + draw_image("/Users/sawyerbenson/Documents/Master Thesis/HPM_Thesis/Writing & Literature/Graphics from pptx/Nonlinearities/area_price_nonlin.png", scale = 0.90)

p4 <- ggdraw() + draw_image("/Users/sawyerbenson/Documents/Master Thesis/HPM_Thesis/Writing & Literature/Graphics from pptx/Nonlinearities/living_area_non_lin_ols.png", scale = 0.90)

plot_grid(p1, p2)
plot_grid(p3, p4)

?plot_grid()

``` 

end of document