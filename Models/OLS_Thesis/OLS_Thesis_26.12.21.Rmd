---
title: "Hedonic Pricing Models"
output:
  html_notebook: default
  pdf_document: default
  word_document: default
code_folding: hide
Author: Sawyer Benson
---

##### Sawyer Benson's Master Thesis 
###### December 26, 2021

<br>

##### **2. Base OLS: Including Outliers**

<br>

Read in packages and data
```{r, results='hide'}
library(readxl) # Import excel data frames
library(ggplot2) # Graphs
library(ggfortify)
library(olsrr) # Testing for heteroscedasticity
library(lmtest)
library(sandwich) # Amending heteroskedasticity 
library(gridExtra) # Organize graphs
library(dplyr) # data_factor wrangling
library(tidyr) # data_factor wrangling
library(tinytex) #for RMarkdown
library(openxlsx) #Export data frame into Excel
library(ggeffects) # plotting marginal effects
library(sjPlot) # plotting marginal effects
library(stargazer) # Showing several outputs next to each other in a STATA style
library(modelsummary)

# Import and attach data sets
data_factor <- read_excel("/Users/sawyerbenson/Documents/Master Thesis/Thesis_Github/Models/Data/Data_Factor/data_factor_clean.xlsx")
attach(data_factor)

data_binary <- read_excel("/Users/sawyerbenson/Documents/Master Thesis/Thesis_Github/Models/Data/Data_Binary/data_binary_clean.xlsx")


# Convert Char to Factors with N Levels
# Structure Change
data_factor$property_type <- as.factor(data_factor$property_type)
data_factor$air_conditioning <- as.factor(data_factor$air_conditioning)
data_factor$appartment_bi <- as.factor(data_factor$appartment_bi)
data_factor$patio_bi <- as.factor(data_factor$patio_bi)
data_factor$school_general <- as.factor(data_factor$school_general)
data_factor$pool_bi <- as.factor(data_factor$pool_bi)
data_factor$rear_yard_access_bi <- as.factor(data_factor$rear_yard_access_bi)
data_factor$roof_type <- as.factor(data_factor$roof_type)
data_factor$gas_type <- as.factor(data_factor$gas_type)
data_factor$out_building_livable_bi <- as.factor(data_factor$out_building_livable_bi)
data_factor$out_building_not_livable_bi <- as.factor(data_factor$out_building_not_livable_bi)
data_factor$appliances_included_bi <- as.factor(data_factor$appliances_included_bi)
data_factor$garage_bi <- as.factor(data_factor$garage_bi)
data_factor$condition <- as.factor(data_factor$condition)
data_factor$energy_efficient_bi <- as.factor(data_factor$energy_efficient_bi)
data_factor$exterior_type <- as.factor(data_factor$exterior_type)
data_factor$exterior_features <- as.factor(data_factor$exterior_features)
data_factor$fire_place_bi <- as.factor(data_factor$fire_place_bi)
data_factor$foundation_type <- as.factor(data_factor$foundation_type)
data_factor$beds_total <- as.factor(data_factor$beds_total)
data_factor$bath_full <- as.factor(data_factor$bath_full)
data_factor$bath_half <- as.factor(data_factor$bath_half)
data_factor$sewer_type <- as.factor(data_factor$sewer_type)
data_factor$spa_location <- as.factor(data_factor$spa_location)
data_factor$stories <- as.factor(data_factor$stories)
data_factor$property_style <- as.factor(data_factor$property_style)
data_factor$city_limit_bi <- as.factor(data_factor$city_limit_bi)
data_factor$subdivision_bi <- as.factor(data_factor$subdivision_bi)
data_factor$termite_contract2 <- as.factor(data_factor$termite_contract2)
data_factor$water_type <- as.factor(data_factor$water_type )
data_factor$waterfront_bi <- as.factor(data_factor$waterfront_bi)
data_factor$post_corona_bi <- as.factor(data_factor$post_corona_bi)
str(data_factor)

# Splits
data_factor$post_corona_bi <- as.factor(data_factor$post_corona_bi)
data_factor$top25_living_area <- as.factor(data_factor$top25_living_area)
data_factor$top50_living_area <- as.factor(data_factor$top50_living_area)
data_factor$bottom25_living_area  <- as.factor(data_factor$bottom25_living_area )
data_factor$bottom50_living_area <- as.factor(data_factor$bottom50_living_area)
data_factor$top25_total_area <- as.factor(data_factor$top25_total_area)
data_factor$top50_total_area <- as.factor(data_factor$top50_total_area)
data_factor$bottom25_total_area <- as.factor(data_factor$bottom25_total_area)
data_factor$bottom50_total_area <- as.factor(data_factor$bottom50_total_area)
data_factor$top25_beds_total <- as.factor(data_factor$top25_beds_total)
data_factor$top50_beds_total <- as.factor(data_factor$top50_beds_total)
data_factor$bottom25_beds_total <- as.factor(data_factor$bottom25_beds_total)
data_factor$bottom50_beds_total <- as.factor(data_factor$bottom50_beds_total)
data_factor$top25_sold_price <- as.factor(data_factor$top25_sold_price)
data_factor$top50_sold_price <- as.factor(data_factor$top50_sold_price)
data_factor$bottom25_sold_price <- as.factor(data_factor$bottom25_sold_price)
data_factor$bottom50_sold_price <- as.factor(data_factor$bottom50_sold_price)
data_factor$top25_dom <- as.factor(data_factor$top25_dom)
data_factor$top50_dom <- as.factor(data_factor$top50_dom)
data_factor$bottom25_dom <- as.factor(data_factor$bottom25_dom)
data_factor$bottom50_dom <- as.factor(data_factor$bottom50_dom)
data_factor$top25_age <- as.factor(data_factor$top25_age)
data_factor$top50_age <- as.factor(data_factor$top50_age)
data_factor$bottom25_age <- as.factor(data_factor$bottom25_age)
data_factor$bottom50_age <- as.factor(data_factor$bottom50_age)
str(data_factor)

# Remove this weird '20' level is bath_full
levels(data_factor$bath_full)
is.na(data_factor$bath_full) <- data_factor$bath_full == "20"
data_factor$bath_full <- factor(data_factor$bath_full)
levels(data_factor$bath_full)


# Data frame without Split Vars
data_factor_core <- data_factor[-c(40:66)]
data_factor_core <- subset(data_factor_core, select = -c(city_limit_bi))
str(data_factor_core)

```

RMarkdown Code: Format chunk output into scroll lists
```{r}
# Installed to limit the length of regression output
# save the built-in output hook
hook_output <- knitr::knit_hooks$get("output")

# set a new output hook to truncate text output
knitr::knit_hooks$set(output = function(x, options) {
  if (!is.null(n <- options$out.lines)) {
    x <- xfun::split_lines(x)
    if (length(x) > n) {
      # truncate the output
      x <- c(head(x, n), "....\n")
    }
    x <- paste(x, collapse = "\n")
  }
  hook_output(x, options)
})
``` 

#### **Variable Wrangling and Tuning**

Check for heteroskedasticity, dependencies, redundancies

<br>

Dealing with Heteroskedasticity
```{r}
# All-inclusive model
lm_check <- lm(sold_price ~  . - new_positive_tests, data = data_factor_core)
summary(lm_check)

# Checking for heteroskedasticity
#  a. Graphically
par(mfrow = c(2,2))
plot(lm_check)

par(mfrow = c(1,1))
autoplot(lm_check)

#  b. Statistically
ols_test_breusch_pagan(lm_check) # Breusch-Pagan test
bptest(lm_check)

# Resolving Heteroskedasticity

# Box-Cox transformation on sold_price
#   - find optimal lambda for Box-Cox transformation 
# bc <- boxcox(sold_price ~ ., data = data_factor_core)
# (lambda <- bc$x[which.max(bc$y)]) # [1] 0.4242424


# fit new linear regression model using the Box-Cox transformation
# lm_check_bc <- lm(((sold_price^lambda-1)/lambda) ~ ., data = data_factor_core)
# summary(lm_check_bc)
# ols_test_breusch_pagan(lm_check_bc)

# Improves, but DID NOT FIX Heteroskedasticity 


# Correct using heteroskedasticity consistent (HC) variance covariance matrix 
# Compare models
stargazer(lm_check,
          coeftest(lm_check, vcov = vcovHC(lm_check, method = "White2", type = "HC0")),
          coeftest(lm_check, vcov = vcovHC(lm_check, method = "White2", type = "HC1")),
          type = "text")


# Todo:
# - Find way to verify lmtest

```


Accounting for Interactions
```{r}

# Note: No need to include interactions in main model

# Checking for interactions 
# Note, using binary data

# data_binary_test <- data_binary[1:20]
# data_binary_test$sold_price <- data_binary$sold_price

data_binary_test <- data_binary[1:15]

lm_check_binary <- lm(data_binary$sold_price ~ ., data = data_binary_test)

(start.time <- Sys.time())
lm_check_binary_interactions <- lm(data_binary$sold_price ~ .^2, data = data_binary_test)
(end.time <- Sys.time())
(time.taken <- end.time - start.time)

options(max.print=1000000)
summary(lm_check)

94^2 # Number of interactions checked

# Isolating only the interaction which are statistically significant

# 1. Create Boolean vector
toselect_x <- summary(lm_check_binary_interactions)$coeff[-1,4] < 0.1
toselect_x

# 2. select sig. variables
relevant_x <- names(toselect_x)[toselect_x == TRUE]
relevant_x

# PROBLEM: interaction are being name with a '1' at the end and that is fucking up the indexing for the last equation.
relevant_x <- sub("1", "", relevant_x)
relevant_x


# 3. formula with only sig. variables
sig_formula <- as.formula(paste("data_binary$sold_price ~",paste(relevant_x, collapse = "+"))) 
sig_formula

sig_model <- lm(formula = sig_formula, data_binary_test)
summary(sig_model)


summ(lm_check_binary, robust = "HC1")
summ(lm_check_binary_interactions, robust = "HC1")
summ(sig_model, robust = "HC1")


# Compare models
stargazer(coeftest(lm_check, vcov = vcovHC(lm_check, method = "White2", type = "HC1")),
          coeftest(lm_check_binary_interactions, vcov = vcovHC(lm_check_binary_interactions, method = "White2", type = "HC1")),
          coeftest(sig_model, vcov = vcovHC(sig_model, method = "White2", type = "HC1")),
          type = "text")


# STOP --------------------------------------------------------------------------------------------------


# Plotting interactions between independent variables
interact_plot(lm_check, pred = living_area , modx = age)


# Remove conflicting or noisy variables
data_factor_core <- subset(data_factor_core, select = -c(sold_date, living_area, stories, land_acres))

lm_check <- lm(log(sold_price) ~ . , data = data_factor_core)
summary(lm_check)
summ(lm_check)
# Checking for non-linearity


interaction_controls <- paste(c("","I(living_area^2)"), collapse = "+")

# 

```

Accounting for Non-linearity
```{r}
# List of all non-factor variables

par(mfrow = c(2,3))

# Age
ggplot(data_factor, aes(x = age , y = sold_price)) + 
    geom_point() + 
    geom_smooth() +
    theme_minimal()

ggplot(data_factor, aes(x = I(age^2) , y = sold_price)) + 
    geom_point() + 
    geom_smooth() +
    theme_minimal()

# Photo Count
ggplot(data_factor, aes(x = photo_count , y = sold_price)) + 
    geom_point() + 
    geom_smooth() +
    theme_minimal()

# Living Area
ggplot(data_factor, aes(x = living_area , y = sold_price)) + 
    geom_point() + 
    geom_smooth() +
    theme_minimal()

ggplot(data_factor, aes(x = land_acres , y = sold_price)) + 
    geom_point() + 
    geom_smooth() +
    theme_minimal()

ggplot(data_factor, aes(x = total_area , y = sold_price)) + 
    geom_point() + 
    geom_smooth() +
    theme_minimal()

ggplot(data_factor, aes(x = days_on_market , y = sold_price)) + 
    geom_point() + 
    geom_smooth() +
    theme_minimal()


ggplot(data_factor, aes(x = total_area , y = living_area/total_area)) + 
    geom_point() + 
    geom_smooth() +
    theme_minimal()

ggplot(data_factor) + 
    geom_smooth(aes(x = sold_price , y = living_area)) + 
    geom_smooth(aes(x = sold_price , y = total_area)) +
    theme_minimal()

ggplot(data_factor, aes(x = new_positive_tests, y = sold_price)) + 
    geom_point() + 
    geom_smooth() +
    theme_minimal()


# Create list of non-linear controls
# (controls_non_linear <- paste(c("I((data_factor_core$age)^2)","I((data_factor_core$living_area)^2)"), collapse = "+"))


# (controls_removed <- paste(c("data_factor_core$total_area", "data_factor_core$sold_data", "data_factor_core$stories"), collapse = "-"))



# Test lm for adjusting
lm_check <- lm(log(sold_price) ~  . + I(age^2) + age 
                                    + I(living_area^2) + living_area
                                    - total_area - stories - sold_date
                                    - new_positive_tests - bath_half
                                    + living_area*beds_total*bath_full,
               
                                
                                           data = data_factor_core)

summary(lm_check)

```

Variable Selection using LASSO
```{r}
library(ggplot2) # Graphs
library(tinytex) #for RMarkdown
library(tidyr) # Data wrangling
library(dplyr) # Data wrangling
library(gridExtra) # Organize graphs
library(boot) # K-fold
library(leaps) # Subset 
library(glmnet) #glmnet() is the main function in the glmnet package (must pass in an x matrix as well as a y vector)

# Set x-y definitions for glmnet package 

x <- model.matrix(log(sold_price) ~ . + I(age^2) + age 
                                      + I(living_area^2) + living_area
                                      - total_area - stories - sold_date
                                      - new_positive_tests - bath_half,
               
                                
                                           data = data_factor_core)[, -1]

y <- log(data_factor_core$sold_price[1:11295])

# General grid
grid <- exp(seq(10, -94, length = 101)) #grid of values from exp(10) [null model] to exp(-15) [least squares]

#Lasso
set.seed(1)
cv.out <- cv.glmnet(x, y, alpha = 1, lambda = grid, nfolds = 10) #lasso
plot(cv.out)
bestlam <- cv.out$lambda.min; bestlam; log(bestlam)
out <- cv.out$glmnet.fit
lasso.coef <- predict(out, type = "coefficients", s = bestlam); lasso.coef; lasso.coef[lasso.coef != 0]
sum(abs(lasso.coef[2:29])) #l1 norm
bestlam2 <- cv.out$lambda.1se; bestlam2; log(bestlam2)

lasso.coef2 <- predict(out, type = "coefficients", s = bestlam2); lasso.coef2; lasso.coef2[lasso.coef2 != 0]
sum(abs(lasso.coef2[2:38]))

```




Finalized Model:
```{r}

lm_final <- lm()


```






# Start of Results 


#### **Subset Analysis**

**Here I test the following:**

1. Is pre and post-corona data_factor significantly different?
   + I test this by testing the significance of a 'corona' dummy variable (1 for post-corona and 0 for pre-corona)
2. Are there significant differences in the way key variables (e.g. premium for bedrooms or &beta;<sub>beds_total</sub>) are impacted by the Corona crisis?
   + I follow a method suggested by UCLA's statistics department which you can read through [**here**](https://stats.idre.ucla.edu/sas/faq/how-can-i-compare-regression-coefficients-across-three-or-more-groups/) if you wish

<br>

##### **Dummy-Variable Regression: Corona = 1**

We see that belonging to the 'post-corona' subset is associated on average with a market **price premium of +$24,390**, ceteris parabus. This finding is statistically significant with **p-value < 0.00** under the most controlled model. In other words, one could also say:

> A house with similar physical features sold **after the first mandated COVID_19 lockdown** will, on average, sell for **$24,390 more** than it would have before this event. 

```{r, attr.output='style="max-height: 350px;"'}


controls <- paste(c(""), )



lm_corona <- lm(sold_price ~ . + beds_total - new_positives_accumulative 
                                    # + I(living_area^2) + living_area 
                                    + I(age^2) + age
                                    + new_positive_tests - total_area - stories - appartment_bi - bath_full - bath_half
                                 
                                   
            
                                 
                            

                                        ,data = data_factor_core)

stargazer(lm_corona,
          coeftest(lm_corona, vcov = vcovHC(lm_corona, method = "White2", type = "HC0")),
          coeftest(lm_corona, vcov = vcovHC(lm_corona, method = "White2", type = "HC1")),
          type = "text")


# Add hetero correction

# Run interactions here
# Run F-test on corona binary

# Trend analysis
#  - convert to real prices
#  - Show trend-line for post corona population compared to population including corona
#  - Make better covid measurment
#  - 


# 1. data pre-covid
# 2. create dummy if observation is in last two years before corona 
# 3. Find other literature

# Issue of trend needs to be address
# 1. Do own analysis
# 2. Fortify with existing literature and clearly listing limitations  


par(mfrow = c(2,2))
plot(lm_corona)
```

##### **Corona = 1 and City = 1**

```{r}
lm_corona_city <- lm(sold_price ~ . + data_factor$post_corona_bi + data_factor$city_limit_bi +      
                                      data_factor$post_corona_bi*data_factor$city_limit_bi +
                                      I(total_area^2) + total_area + #Controls
                                      I(age^2) + age,                 #Controls
                                                                    data = data_factor_core)

summary(lm_corona_city)

par(mfrow = c(2,2))
plot(lm_corona_city)
```

##### **Corona = 1 and Top vs. Bottom 25% Price**

```{r}
lm_corona_price_top <- lm(sold_price ~ data_factor$post_corona_bi + data_factor$top25_sold_price +      
                                  data_factor$post_corona_bi*data_factor$top25_sold_price + .,
                     
                                                                    data = data_factor_core)

summary(lm_corona_price_top)

par(mfrow = c(2,2))
plot(lm_corona_price_top)

lm_corona_price_bottom <- lm(sold_price ~ data_factor$post_corona_bi + data_factor$bottom25_sold_price +      
                                  data_factor$post_corona_bi*data_factor$bottom25_sold_price + .,
                     
                                                                    data = data_factor_core)

summary(lm_corona_price_bottom)

par(mfrow = c(2,2))
plot(lm_corona_price_bottom)

# Yuki will look into method here**
# Quantile regression

```


##### **Corona = 1 and Top vs. Bottom 25% Size**

```{r}
lm_corona_size_top <- lm(sold_price ~ data_factor$post_corona_bi + data_factor$top25_total_area +      
                                  data_factor$post_corona_bi*data_factor$top25_total_area + .,
                     
                                                                    data = data_factor_core)

summary(lm_corona_size_top)

par(mfrow = c(2,2))
plot(lm_corona_size_top)

lm_corona_size_bottom <- lm(sold_price ~ data_factor$post_corona_bi + data_factor$bottom25_total_area +      
                                  data_factor$post_corona_bi*data_factor$bottom25_total_area + .,
                     
                                                                    data = data_factor_core)

summary(lm_corona_size_bottom)

par(mfrow = c(2,2))
plot(lm_corona_size_bottom)
```

##### **Corona = 1 and Top vs. Bottom 25% Age**

```{r}
lm_corona_age_top <- lm(sold_price ~ data_factor$post_corona_bi + data_factor$top25_dom +      
                                  data_factor$post_corona_bi*data_factor$top25_dom + .,
                     
                                                                    data = data_factor_core)

summary(lm_corona_age_top)

par(mfrow = c(2,2))
plot(lm_corona_age_top)

lm_corona_age_bottom <- lm(sold_price ~ data_factor$post_corona_bi + data_factor$bottom25_total_area +      
                                  data_factor$post_corona_bi*data_factor$bottom25_total_area + .,
                     
                                                                    data = data_factor_core)

summary(lm_corona_age_bottom)
```

<br>

##### **5.2 Testing Differences of Specific Variables Post and Pre-Corona**

This [**UCLA method**](https://stats.idre.ucla.edu/sas/faq/how-can-i-compare-regression-coefficients-across-three-or-more-groups/) is implimented with the following steps:

1. Run a reduced regression model with only:
   + subset dummy variable (e.g. corona dummy)
   + variable of interest (e.g. beds_total)
   + interaction term: (e.g. corona_dummy*beds_total)
   
**Note:** The results of the significance level for the interaction term's beta coefficient tests the null hypothesis: **H<sub>0</sub>: &beta;<sub>pre</sub> = &beta;<sub>post</sub>.**

<br>

##### **Number of Bedrooms**

As you can see, the interaction term (i.e. beds_total*post_corona_bi) is statistically significant at the 0.00 level, suggesting we reject the null hypothesis that &beta;<sub>pre</sub> = &beta;<sub>post</sub>.

This result can also be interpreted as:

> *The average premium for each additional bedroom significantly increased after the outbreak of COVID-19 in March 23, 2020, resulting in an **average premium increase of $8,583 per room**, ceteris parabus.*

> *My (the author's) hypothesis is that this result is likely driven by an increased demand for an additional bedroom functioning as a **'home office'** as many workers were legally compelled to work from home, with many of them **never returning** to full-time, on-site working schedules.*

```{r, attr.output='style="max-height: 350px;"'}

# Corona
lm_corona_beds <- lm(sold_price ~ . +   data_factor$post_corona_bi + beds_total +      
                                        data_factor$post_corona_bi*beds_total +
                                        I(total_area^2) + total_area +  #Controls
                                        I(age^2) + age + beds_total,    #Controls
                     
                                                                    data = data_factor_core)
summary(lm_corona_beds)

# beds_total2:data_factor$post_corona_bi1  2.055e+04  1.166e+04   1.762 0.078050 .  
# beds_total3:data_factor$post_corona_bi1  3.315e+04  1.139e+04   2.909 0.003631 ** 
# beds_total4:data_factor$post_corona_bi1  4.504e+04  1.155e+04   3.901 9.65e-05 ***
# beds_total5:data_factor$post_corona_bi1  5.844e+04  1.469e+04   3.980 6.95e-05 ***

# Corona + City
data_city_long <- subset(data_factor, data_factor$city_limit_bi == 1)
data_city_short <- data_city_long[-c(40:64)]
data_city_short <- subset(data_city_short, select = -c(city_limit_bi))


lm_corona_beds_city <- lm(sold_price ~ . + data_city_long$post_corona_bi + beds_total +      
                                           data_city_long$post_corona_bi*beds_total,
                                                                    
                                                                    
                                                                    data = data_city_short)

summary(lm_corona_beds_city)

# beds_total2:data_city_long$post_corona_bi1  1.876e+04  1.178e+04   1.592 0.111432    
# beds_total3:data_city_long$post_corona_bi1  3.120e+04  1.154e+04   2.704 0.006868 ** 
# beds_total4:data_city_long$post_corona_bi1  4.075e+04  1.170e+04   3.484 0.000496 ***
# beds_total5:data_city_long$post_corona_bi1  4.841e+04  1.481e+04   3.268 0.001085 ** 

plot_model(lm_corona_beds, type = "pred", terms = "age")

```




```{r}

data_factor$days_on_market <- as.numeric(data_factor$days_on_market)

lm_dom <- lm(log(sold_price) ~ days_on_market + sold_price + . , 
                                   data = data_factor)
summary(lm_dom)

plot_model(lm_dom, type = "pred", terms = "days_on_market")

```


<br><br>


*End of Document*

